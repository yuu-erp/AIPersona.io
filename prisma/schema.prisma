// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- ENUMS ---

enum UserRole {
  ADMIN
  USER
}

enum PlanType {
  FREE
  PRO
  ULTRA
}

enum PostStatus {
  DRAFT
  PROCESSING
  PENDING_APPROVAL
  REJECTED
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
}

enum SocialPlatform {
  TIKTOK
  FACEBOOK
  INSTAGRAM
  TWITTER
  YOUTUBE
}

// --- MODELS ---

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  password        String? // Nullable nếu chỉ dùng Google Login
  fullName        String?
  avatarUrl       String?
  role            UserRole @default(USER)
  isEmailVerified Boolean  @default(false)

  // Quản lý gói cước
  plan             PlanType  @default(FREE)
  planExpiresAt    DateTime?
  customerStripeId String?   @unique

  // Relations
  personas       AiPersona[]
  socialAccounts SocialAccount[]
  posts          Post[]
  dailyQuotas    DailyQuota[] // Theo dõi lượt dùng hàng ngày

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model AiPersona {
  id             String  @id @default(uuid())
  name           String
  baseFaceUrl    String // Ảnh gốc để swap face
  loraModelPath  String? // Path tới file LoRA nếu có
  featuresConfig Json // { eyeColor: string, bodyType: string, etc. } - Type-safe via DTO

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  posts Post[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_personas")
}

model SocialAccount {
  id           String         @id @default(uuid())
  platform     SocialPlatform
  platformId   String // ID của user trên TikTok/FB
  accountName  String?
  accessToken  String         @db.Text
  refreshToken String?        @db.Text
  expiresAt    DateTime?

  // Chế độ kiểm duyệt cho từng kênh
  isModerationEnabled Boolean @default(true)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  posts Post[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([platform, platformId])
  @@map("social_accounts")
}

model Post {
  id          String     @id @default(uuid())
  title       String?
  content     String?    @db.Text
  mediaUrl    String? // Video hoặc ảnh đã render xong
  status      PostStatus @default(DRAFT)
  scheduledAt DateTime? // Thời gian đăng dự kiến
  publishedAt DateTime? // Thời gian thực tế đã đăng

  // Metadata cho AI
  aiPrompt   String? @db.Text
  aiMetadata Json? // Lưu log từ AI Worker (Seed, Sampler...)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  personaId String?
  persona   AiPersona? @relation(fields: [personaId], references: [id])

  channelId String?
  channel   SocialAccount? @relation(fields: [channelId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("posts")
}

model DailyQuota {
  id         String   @id @default(uuid())
  userId     String
  date       DateTime @default(now()) @db.Date // Chỉ lưu ngày YYYY-MM-DD
  videoCount Int      @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("daily_quotas")
}
